{% extends "core/base.jinja" %}
{% from "core/macros.jinja" import user_mini_profile, user_subscription %}

{% block title %}
  {{ counter }}
{% endblock %}

{% block additional_css %}
  <link rel="stylesheet" type="text/css" href="{{ static('bundled/core/components/ajax-select-index.css') }}" defer></link>
  <link rel="stylesheet" type="text/css" href="{{ static('core/components/ajax-select.scss') }}" defer></link>
{% endblock %}

{% block additional_js %}
  <script type="module" src="{{ static('bundled/counter/counter-click-index.ts') }}"></script>
  <script type="module" src="{{ static('bundled/counter/components/counter-product-select-index.ts') }}"></script>
{% endblock %}

{% block info_boxes %}
{% endblock %}


{% block nav %}
{% endblock %}

{% block content %}
  <h4 id="click_interface">{{ counter }}</h4>

  <div id="bar-ui" x-data="counter">
    <noscript>
      <p class="important">Javascript is required for the counter UI.</p>
    </noscript>

    <div id="user_info">
      <h5>{% trans %}Customer{% endtrans %}</h5>
      {{ user_mini_profile(customer.user) }}
      {{ user_subscription(customer.user) }}
      <p>{% trans %}Amount: {% endtrans %}<span x-text="customerBalance"></span> €
        <span x-cloak x-show="getBasketSize() > 0">
          <i class="fa-solid fa-arrow-right"></i>
          <span x-text="(customerBalance - sumBasket()).toLocaleString(undefined, { minimumFractionDigits: 2 })"></span> €
        </span>
      </p>
    </div>

    <div id="click_form" style="width: 20%;">
      <h5 id="selling-accordion">{% trans %}Selling{% endtrans %}</h5>
      <div>
        {% set counter_click_url = url('counter:click', counter_id=counter.id, user_id=customer.user_id) %}

                {# Formulaire pour rechercher un produit en tapant son code dans une barre de recherche #}
        <form method="post" action=""
              class="code_form" @submit.prevent="handleCode">
          {% csrf_token %}

          <input type="hidden" name="action" value="code">

          <counter-product-select name="code" x-ref="codeField" autofocus required placeholder="{% trans %}Select a product...{% endtrans %}">
            <option value=""></option>
            <optgroup label="{% trans %}Operations{% endtrans %}">
              <option value="FIN">{% trans %}Confirm (FIN){% endtrans %}</option>
              <option value="ANN">{% trans %}Cancel (ANN){% endtrans %}</option>
            </optgroup>
            {% for category in categories.keys() %}
              <optgroup label="{{ category }}">
                {% for product in categories[category] %}
                  <option value="{{ product.id }}">{{ product }}</option>
                {% endfor %}
              </optgroup>
            {% endfor %}
          </counter-product-select>

          <input type="submit" value="{% trans %}Go{% endtrans %}"/>
        </form>

        {% for error in form.non_form_errors() %}
          <div class="alert alert-red">
            {{ error }}
          </div>
        {% endfor %}
        <p>{% trans %}Basket: {% endtrans %}</p>
        <form method="post" action="" x-ref="basketForm">
          {% csrf_token %}
          <div x-ref="basketManagementForm">
            {{ form.management_form }}
          </div>
          <template x-for="(item, index) in Object.values(basket)">
            <ul>
              <template x-for="error in item.errors">
                <div class="alert alert-red" x-text="error">
                </div>
              </template>

              <button @click.prevent="addToBasket(item.product.id, -1)">-</button>
              <span x-text="item.quantity"></span>
              <button @click.prevent="addToBasket(item.product.id, 1)">+</button>

              <span x-text="item.product.name"></span> :
              <span x-text="item.sum().toLocaleString(undefined, { minimumFractionDigits: 2 })">€</span>
              <span x-cloak x-show="item.getBonusQuantity() > 0" x-text="`${item.getBonusQuantity()} x P`"></span>
              <button @click.prevent="removeFromBasket(item.product.id)"><i class="fa fa-trash-can delete-action"></i></button>

              <input type="hidden" :value="item.quantity" :id="`id_form-${index}-quantity`" :name="`form-${index}-quantity`" required readonly>
              <input type="hidden" :value="item.product.id" :id="`id_form-${index}-id`" :name="`form-${index}-id`" required readonly>
            </ul>
          </template>

          <p>
            <strong>Total: </strong>
            <strong x-text="sumBasket().toLocaleString(undefined, { minimumFractionDigits: 2 })"></strong>
            <strong> €</strong>
          </p>

          <input type="submit" @click.prevent="finish" value="{% trans %}Finish{% endtrans %}"/>
          <input type="submit" @click.prevent="cancel" value="{% trans %}Cancel{% endtrans %}"/>
        </form>
      </div>
      {% if object.type == "BAR" %}
        <h5>{% trans %}Refilling{% endtrans %}</h5>
        {% if refilling_fragment %}
          <div
            @htmx:after-request="onRefillingSuccess"
          >
            {{ refilling_fragment }}
          </div>
        {% else %}
          <div>
            <p class="alert alert-yellow">
              {% trans trimmed %}
                As a barman, you are not able to refill any account on your own.
                An admin should be connected on this counter for that.
                The customer can refill by using the eboutic.
              {% endtrans %}
            </p>
          </div>
        {% endif %}
        {% if student_card_fragment %}
          <h5>{% trans %}Student card{% endtrans %}</h3>
          <div>
            {{ student_card_fragment }}
          </div>
        {% endif %}

      {% endif %}
    </div>

    <div id="products">
      <ul>
        {% for category in categories.keys() -%}
          <li><a href="#cat_{{ category|slugify }}">{{ category }}</a></li>
        {%- endfor %}
      </ul>
      {% for category in categories.keys() -%}
        <div id="cat_{{ category|slugify }}">
          <h5>{{ category }}</h5>
          {% for product in categories[category] -%}
            <button @click="addToBasket('{{ product.id }}', 1)">
              <strong>{{ product.name }}</strong>
              {% if product.icon %}
                <img src="{{ product.icon.url }}" alt="image de {{ product.name }}"/>
              {% else %}
                <img src="{{ static('core/img/na.gif') }}" alt="image de {{ product.name }}"/>
              {% endif %}
              <span>{{ product.price }} €<br>{{ product.code }}</span>
            </button>
          {%- endfor %}
        </div>
      {%- endfor %}
    </div>
  </div>
{% endblock content %}

{% block script %}
  {{ super() }}
  <script>
    const products = {
      {%- for product in products -%}
        {{ product.id }}: {
          id: "{{ product.id }}",
          name: "{{ product.name }}",
          price: {{ product.price }},
          hasTrayPrice: {{ product.tray | tojson }},
        },
      {%- endfor -%}
    };
    const formInitial = [
      {%- for f in form -%}
        {%- if f.cleaned_data -%}
          {
            {%- if f.cleaned_data["id"] -%}
              id: '{{ f.cleaned_data["id"] | tojson }}',
            {%- endif -%}
            {%- if f.cleaned_data["quantity"] -%}
              quantity: {{ f.cleaned_data["quantity"] | tojson }},
            {%- endif -%}
            errors: {{ form_errors[loop.index0] | tojson }},
          },
        {%- endif -%}
      {%- endfor -%}
    ];
    window.addEventListener("DOMContentLoaded", () => {
      loadCounter({
        csrfToken: "{{ csrf_token }}",
        clickApiUrl: "{{ url('counter:click', counter_id=counter.id, user_id=customer.user.id) }}", customerBalance: {{ customer.amount }},
        products: products,
        customerId: {{ customer.pk }},
        formInitial: formInitial,
      });
    });
  </script>
{% endblock script %}